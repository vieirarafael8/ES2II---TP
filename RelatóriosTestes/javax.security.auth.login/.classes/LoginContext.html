


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: LoginContext</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">javax.security.auth.login</a> ]
</div>

<h1>Coverage Summary for Class: LoginContext (javax.security.auth.login)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LoginContext</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 215)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LoginContext$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$ModuleInfo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$SecureCallbackHandler</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LoginContext$SecureCallbackHandler$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 250)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<div class="sourceCode"><i>1</i>&nbsp;/*
<i>2</i>&nbsp; * Copyright (c) 1998, 2015, Oracle and/or its affiliates. All rights reserved.
<i>3</i>&nbsp; * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
<i>4</i>&nbsp; *
<i>5</i>&nbsp; *
<i>6</i>&nbsp; *
<i>7</i>&nbsp; *
<i>8</i>&nbsp; *
<i>9</i>&nbsp; *
<i>10</i>&nbsp; *
<i>11</i>&nbsp; *
<i>12</i>&nbsp; *
<i>13</i>&nbsp; *
<i>14</i>&nbsp; *
<i>15</i>&nbsp; *
<i>16</i>&nbsp; *
<i>17</i>&nbsp; *
<i>18</i>&nbsp; *
<i>19</i>&nbsp; *
<i>20</i>&nbsp; *
<i>21</i>&nbsp; *
<i>22</i>&nbsp; *
<i>23</i>&nbsp; *
<i>24</i>&nbsp; */
<i>25</i>&nbsp;
<i>26</i>&nbsp;package javax.security.auth.login;
<i>27</i>&nbsp;
<i>28</i>&nbsp;import java.security.AccessController;
<i>29</i>&nbsp;import java.security.PrivilegedAction;
<i>30</i>&nbsp;import java.util.Map;
<i>31</i>&nbsp;import java.util.HashMap;
<i>32</i>&nbsp;import java.text.MessageFormat;
<i>33</i>&nbsp;import javax.security.auth.Subject;
<i>34</i>&nbsp;import javax.security.auth.AuthPermission;
<i>35</i>&nbsp;import javax.security.auth.callback.*;
<i>36</i>&nbsp;import javax.security.auth.spi.LoginModule;
<i>37</i>&nbsp;import java.security.AccessControlContext;
<i>38</i>&nbsp;import java.util.ServiceLoader;
<i>39</i>&nbsp;
<i>40</i>&nbsp;import sun.security.util.PendingException;
<i>41</i>&nbsp;import sun.security.util.ResourcesMgr;
<i>42</i>&nbsp;
<i>43</i>&nbsp;/**
<i>44</i>&nbsp; * &lt;p&gt; The {@code LoginContext} class describes the basic methods used
<i>45</i>&nbsp; * to authenticate Subjects and provides a way to develop an
<i>46</i>&nbsp; * application independent of the underlying authentication technology.
<i>47</i>&nbsp; * A {@code Configuration} specifies the authentication technology, or
<i>48</i>&nbsp; * {@code LoginModule}, to be used with a particular application.
<i>49</i>&nbsp; * Different LoginModules can be plugged in under an application
<i>50</i>&nbsp; * without requiring any modifications to the application itself.
<i>51</i>&nbsp; *
<i>52</i>&nbsp; * &lt;p&gt; In addition to supporting &lt;i&gt;pluggable&lt;/i&gt; authentication, this class
<i>53</i>&nbsp; * also supports the notion of &lt;i&gt;stacked&lt;/i&gt; authentication.
<i>54</i>&nbsp; * Applications may be configured to use more than one
<i>55</i>&nbsp; * LoginModule.  For example, one could
<i>56</i>&nbsp; * configure both a Kerberos LoginModule and a smart card
<i>57</i>&nbsp; * LoginModule under an application.
<i>58</i>&nbsp; *
<i>59</i>&nbsp; * &lt;p&gt; A typical caller instantiates a LoginContext with
<i>60</i>&nbsp; * a &lt;i&gt;name&lt;/i&gt; and a {@code CallbackHandler}.
<i>61</i>&nbsp; * LoginContext uses the &lt;i&gt;name&lt;/i&gt; as the index into a
<i>62</i>&nbsp; * Configuration to determine which LoginModules should be used,
<i>63</i>&nbsp; * and which ones must succeed in order for the overall authentication to
<i>64</i>&nbsp; * succeed.  The {@code CallbackHandler} is passed to the underlying
<i>65</i>&nbsp; * LoginModules so they may communicate and interact with users
<i>66</i>&nbsp; * (prompting for a username and password via a graphical user interface,
<i>67</i>&nbsp; * for example).
<i>68</i>&nbsp; *
<i>69</i>&nbsp; * &lt;p&gt; Once the caller has instantiated a LoginContext,
<i>70</i>&nbsp; * it invokes the {@code login} method to authenticate
<i>71</i>&nbsp; * a {@code Subject}.  The {@code login} method invokes
<i>72</i>&nbsp; * the configured modules to perform their respective types of authentication
<i>73</i>&nbsp; * (username/password, smart card pin verification, etc.).
<i>74</i>&nbsp; * Note that the LoginModules will not attempt authentication retries nor
<i>75</i>&nbsp; * introduce delays if the authentication fails.
<i>76</i>&nbsp; * Such tasks belong to the LoginContext caller.
<i>77</i>&nbsp; *
<i>78</i>&nbsp; * &lt;p&gt; If the {@code login} method returns without
<i>79</i>&nbsp; * throwing an exception, then the overall authentication succeeded.
<i>80</i>&nbsp; * The caller can then retrieve
<i>81</i>&nbsp; * the newly authenticated Subject by invoking the
<i>82</i>&nbsp; * {@code getSubject} method.  Principals and Credentials associated
<i>83</i>&nbsp; * with the Subject may be retrieved by invoking the Subject&#39;s
<i>84</i>&nbsp; * respective {@code getPrincipals}, {@code getPublicCredentials},
<i>85</i>&nbsp; * and {@code getPrivateCredentials} methods.
<i>86</i>&nbsp; *
<i>87</i>&nbsp; * &lt;p&gt; To logout the Subject, the caller calls
<i>88</i>&nbsp; * the {@code logout} method.  As with the {@code login}
<i>89</i>&nbsp; * method, this {@code logout} method invokes the {@code logout}
<i>90</i>&nbsp; * method for the configured modules.
<i>91</i>&nbsp; *
<i>92</i>&nbsp; * &lt;p&gt; A LoginContext should not be used to authenticate
<i>93</i>&nbsp; * more than one Subject.  A separate LoginContext
<i>94</i>&nbsp; * should be used to authenticate each different Subject.
<i>95</i>&nbsp; *
<i>96</i>&nbsp; * &lt;p&gt; The following documentation applies to all LoginContext constructors:
<i>97</i>&nbsp; * &lt;ol&gt;
<i>98</i>&nbsp; *
<i>99</i>&nbsp; * &lt;li&gt; {@code Subject}
<i>100</i>&nbsp; * &lt;ul&gt;
<i>101</i>&nbsp; * &lt;li&gt; If the constructor has a Subject
<i>102</i>&nbsp; * input parameter, the LoginContext uses the caller-specified
<i>103</i>&nbsp; * Subject object.
<i>104</i>&nbsp; *
<i>105</i>&nbsp; * &lt;li&gt; If the caller specifies a {@code null} Subject
<i>106</i>&nbsp; * and a {@code null} value is permitted,
<i>107</i>&nbsp; * the LoginContext instantiates a new Subject.
<i>108</i>&nbsp; *
<i>109</i>&nbsp; * &lt;li&gt; If the constructor does &lt;b&gt;not&lt;/b&gt; have a Subject
<i>110</i>&nbsp; * input parameter, the LoginContext instantiates a new Subject.
<i>111</i>&nbsp; * &lt;/ul&gt;
<i>112</i>&nbsp; *
<i>113</i>&nbsp; * &lt;li&gt; {@code Configuration}
<i>114</i>&nbsp; * &lt;ul&gt;
<i>115</i>&nbsp; * &lt;li&gt; If the constructor has a Configuration
<i>116</i>&nbsp; * input parameter and the caller specifies a non-null Configuration,
<i>117</i>&nbsp; * the LoginContext uses the caller-specified Configuration.
<i>118</i>&nbsp; * &lt;p&gt;
<i>119</i>&nbsp; * If the constructor does &lt;b&gt;not&lt;/b&gt; have a Configuration
<i>120</i>&nbsp; * input parameter, or if the caller specifies a {@code null}
<i>121</i>&nbsp; * Configuration object, the constructor uses the following call to
<i>122</i>&nbsp; * get the installed Configuration:
<i>123</i>&nbsp; * &lt;pre&gt;
<i>124</i>&nbsp; *      config = Configuration.getConfiguration();
<i>125</i>&nbsp; * &lt;/pre&gt;
<i>126</i>&nbsp; * For both cases,
<i>127</i>&nbsp; * the &lt;i&gt;name&lt;/i&gt; argument given to the constructor is passed to the
<i>128</i>&nbsp; * {@code Configuration.getAppConfigurationEntry} method.
<i>129</i>&nbsp; * If the Configuration has no entries for the specified &lt;i&gt;name&lt;/i&gt;,
<i>130</i>&nbsp; * then the {@code LoginContext} calls
<i>131</i>&nbsp; * {@code getAppConfigurationEntry} with the name, &quot;&lt;i&gt;other&lt;/i&gt;&quot;
<i>132</i>&nbsp; * (the default entry name).  If there is no entry for &quot;&lt;i&gt;other&lt;/i&gt;&quot;,
<i>133</i>&nbsp; * then a {@code LoginException} is thrown.
<i>134</i>&nbsp; *
<i>135</i>&nbsp; * &lt;li&gt; When LoginContext uses the installed Configuration, the caller
<i>136</i>&nbsp; * requires the createLoginContext.&lt;em&gt;name&lt;/em&gt; and possibly
<i>137</i>&nbsp; * createLoginContext.other AuthPermissions. Furthermore, the
<i>138</i>&nbsp; * LoginContext will invoke configured modules from within an
<i>139</i>&nbsp; * {@code AccessController.doPrivileged} call so that modules that
<i>140</i>&nbsp; * perform security-sensitive tasks (such as connecting to remote hosts,
<i>141</i>&nbsp; * and updating the Subject) will require the respective permissions, but
<i>142</i>&nbsp; * the callers of the LoginContext will not require those permissions.
<i>143</i>&nbsp; *
<i>144</i>&nbsp; * &lt;li&gt; When LoginContext uses a caller-specified Configuration, the caller
<i>145</i>&nbsp; * does not require any createLoginContext AuthPermission.  The LoginContext
<i>146</i>&nbsp; * saves the {@code AccessControlContext} for the caller,
<i>147</i>&nbsp; * and invokes the configured modules from within an
<i>148</i>&nbsp; * {@code AccessController.doPrivileged} call constrained by that context.
<i>149</i>&nbsp; * This means the caller context (stored when the LoginContext was created)
<i>150</i>&nbsp; * must have sufficient permissions to perform any security-sensitive tasks
<i>151</i>&nbsp; * that the modules may perform.
<i>152</i>&nbsp; * &lt;/ul&gt;
<i>153</i>&nbsp; *
<i>154</i>&nbsp; * &lt;li&gt; {@code CallbackHandler}
<i>155</i>&nbsp; * &lt;ul&gt;
<i>156</i>&nbsp; * &lt;li&gt; If the constructor has a CallbackHandler
<i>157</i>&nbsp; * input parameter, the LoginContext uses the caller-specified
<i>158</i>&nbsp; * CallbackHandler object.
<i>159</i>&nbsp; *
<i>160</i>&nbsp; * &lt;li&gt; If the constructor does &lt;b&gt;not&lt;/b&gt; have a CallbackHandler
<i>161</i>&nbsp; * input parameter, or if the caller specifies a {@code null}
<i>162</i>&nbsp; * CallbackHandler object (and a {@code null} value is permitted),
<i>163</i>&nbsp; * the LoginContext queries the
<i>164</i>&nbsp; * {@code auth.login.defaultCallbackHandler} security property for the
<i>165</i>&nbsp; * fully qualified class name of a default handler
<i>166</i>&nbsp; * implementation. If the security property is not set,
<i>167</i>&nbsp; * then the underlying modules will not have a
<i>168</i>&nbsp; * CallbackHandler for use in communicating
<i>169</i>&nbsp; * with users.  The caller thus assumes that the configured
<i>170</i>&nbsp; * modules have alternative means for authenticating the user.
<i>171</i>&nbsp; *
<i>172</i>&nbsp; *
<i>173</i>&nbsp; * &lt;li&gt; When the LoginContext uses the installed Configuration (instead of
<i>174</i>&nbsp; * a caller-specified Configuration, see above),
<i>175</i>&nbsp; * then this LoginContext must wrap any
<i>176</i>&nbsp; * caller-specified or default CallbackHandler implementation
<i>177</i>&nbsp; * in a new CallbackHandler implementation
<i>178</i>&nbsp; * whose {@code handle} method implementation invokes the
<i>179</i>&nbsp; * specified CallbackHandler&#39;s {@code handle} method in a
<i>180</i>&nbsp; * {@code java.security.AccessController.doPrivileged} call
<i>181</i>&nbsp; * constrained by the caller&#39;s current {@code AccessControlContext}.
<i>182</i>&nbsp; * &lt;/ul&gt;
<i>183</i>&nbsp; * &lt;/ol&gt;
<i>184</i>&nbsp; *
<i>185</i>&nbsp; * @since 1.4
<i>186</i>&nbsp; * @see java.security.Security
<i>187</i>&nbsp; * @see javax.security.auth.AuthPermission
<i>188</i>&nbsp; * @see javax.security.auth.Subject
<i>189</i>&nbsp; * @see javax.security.auth.callback.CallbackHandler
<i>190</i>&nbsp; * @see javax.security.auth.login.Configuration
<i>191</i>&nbsp; * @see javax.security.auth.spi.LoginModule
<i>192</i>&nbsp; * @see java.security.Security security properties
<i>193</i>&nbsp; */
<i>194</i>&nbsp;public class LoginContext {
<b class="nc"><i>195</i>&nbsp;</b>
<i>196</i>&nbsp;    private static final String LOGIN_METHOD            = &quot;login&quot;;
<i>197</i>&nbsp;    private static final String COMMIT_METHOD           = &quot;commit&quot;;
<i>198</i>&nbsp;    private static final String ABORT_METHOD            = &quot;abort&quot;;
<i>199</i>&nbsp;    private static final String LOGOUT_METHOD           = &quot;logout&quot;;
<i>200</i>&nbsp;    private static final String OTHER                   = &quot;other&quot;;
<i>201</i>&nbsp;    private static final String DEFAULT_HANDLER         =
<i>202</i>&nbsp;                                &quot;auth.login.defaultCallbackHandler&quot;;
<i>203</i>&nbsp;    private Subject subject = null;
<i>204</i>&nbsp;    private boolean subjectProvided = false;
<b class="nc"><i>205</i>&nbsp;    private boolean loginSucceeded = false;</b>
<b class="nc"><i>206</i>&nbsp;    private CallbackHandler callbackHandler;</b>
<b class="nc"><i>207</i>&nbsp;    private Map&lt;String,?&gt; state = new HashMap&lt;String,Object&gt;();</b>
<i>208</i>&nbsp;
<b class="nc"><i>209</i>&nbsp;    private Configuration config;</b>
<i>210</i>&nbsp;    private AccessControlContext creatorAcc = null;  // customized config only
<i>211</i>&nbsp;    private ModuleInfo[] moduleStack;
<b class="nc"><i>212</i>&nbsp;    private ClassLoader contextClassLoader = null;</b>
<i>213</i>&nbsp;
<b class="nc"><i>214</i>&nbsp;    // state saved in the event a user-specified asynchronous exception</b>
<b class="nc"><i>215</i>&nbsp;    // was specified and thrown</b>
<i>216</i>&nbsp;
<i>217</i>&nbsp;    private int moduleIndex = 0;
<i>218</i>&nbsp;    private LoginException firstError = null;
<i>219</i>&nbsp;    private LoginException firstRequiredError = null;
<b class="nc"><i>220</i>&nbsp;    private boolean success = false;</b>
<b class="nc"><i>221</i>&nbsp;</b>
<b class="nc"><i>222</i>&nbsp;    private static final sun.security.util.Debug debug =</b>
<b class="nc"><i>223</i>&nbsp;        sun.security.util.Debug.getInstance(&quot;logincontext&quot;, &quot;\t[LoginContext]&quot;);</b>
<i>224</i>&nbsp;
<i>225</i>&nbsp;    private void init(String name) throws LoginException {
<b class="nc"><i>226</i>&nbsp;</b>
<i>227</i>&nbsp;        SecurityManager sm = System.getSecurityManager();
<i>228</i>&nbsp;        if (sm != null &amp;&amp; creatorAcc == null) {
<i>229</i>&nbsp;            sm.checkPermission(new AuthPermission
<b class="nc"><i>230</i>&nbsp;                                (&quot;createLoginContext.&quot; + name));</b>
<b class="nc"><i>231</i>&nbsp;        }</b>
<b class="nc"><i>232</i>&nbsp;</b>
<i>233</i>&nbsp;        if (name == null)
<i>234</i>&nbsp;            throw new LoginException
<i>235</i>&nbsp;                (ResourcesMgr.getString(&quot;Invalid.null.input.name&quot;));
<b class="nc"><i>236</i>&nbsp;</b>
<b class="nc"><i>237</i>&nbsp;        // get the Configuration</b>
<b class="nc"><i>238</i>&nbsp;        if (config == null) {</b>
<i>239</i>&nbsp;            config = java.security.AccessController.doPrivileged
<i>240</i>&nbsp;                (new java.security.PrivilegedAction&lt;Configuration&gt;() {
<b class="nc"><i>241</i>&nbsp;                public Configuration run() {</b>
<b class="nc"><i>242</i>&nbsp;                    return Configuration.getConfiguration();</b>
<b class="nc"><i>243</i>&nbsp;                }</b>
<i>244</i>&nbsp;            });
<b class="nc"><i>245</i>&nbsp;        }</b>
<i>246</i>&nbsp;
<i>247</i>&nbsp;        // get the LoginModules configured for this application
<i>248</i>&nbsp;        AppConfigurationEntry[] entries = config.getAppConfigurationEntry(name);
<i>249</i>&nbsp;        if (entries == null) {
<i>250</i>&nbsp;
<b class="nc"><i>251</i>&nbsp;            if (sm != null &amp;&amp; creatorAcc == null) {</b>
<b class="nc"><i>252</i>&nbsp;                sm.checkPermission(new AuthPermission</b>
<i>253</i>&nbsp;                                (&quot;createLoginContext.&quot; + OTHER));
<b class="nc"><i>254</i>&nbsp;            }</b>
<b class="nc"><i>255</i>&nbsp;</b>
<i>256</i>&nbsp;            entries = config.getAppConfigurationEntry(OTHER);
<i>257</i>&nbsp;            if (entries == null) {
<i>258</i>&nbsp;                MessageFormat form = new MessageFormat(ResourcesMgr.getString
<b class="nc"><i>259</i>&nbsp;                        (&quot;No.LoginModules.configured.for.name&quot;));</b>
<b class="nc"><i>260</i>&nbsp;                Object[] source = {name};</b>
<b class="nc"><i>261</i>&nbsp;                throw new LoginException(form.format(source));</b>
<b class="nc"><i>262</i>&nbsp;            }</b>
<b class="nc"><i>263</i>&nbsp;        }</b>
<b class="nc"><i>264</i>&nbsp;        moduleStack = new ModuleInfo[entries.length];</b>
<i>265</i>&nbsp;        for (int i = 0; i &lt; entries.length; i++) {
<i>266</i>&nbsp;            // clone returned array
<b class="nc"><i>267</i>&nbsp;            moduleStack[i] = new ModuleInfo</b>
<b class="nc"><i>268</i>&nbsp;                                (new AppConfigurationEntry</b>
<i>269</i>&nbsp;                                        (entries[i].getLoginModuleName(),
<b class="nc"><i>270</i>&nbsp;                                        entries[i].getControlFlag(),</b>
<i>271</i>&nbsp;                                        entries[i].getOptions()),
<b class="nc"><i>272</i>&nbsp;                                null);</b>
<b class="nc"><i>273</i>&nbsp;        }</b>
<b class="nc"><i>274</i>&nbsp;</b>
<i>275</i>&nbsp;        contextClassLoader = java.security.AccessController.doPrivileged
<i>276</i>&nbsp;                (new java.security.PrivilegedAction&lt;ClassLoader&gt;() {
<i>277</i>&nbsp;                public ClassLoader run() {
<b class="nc"><i>278</i>&nbsp;                    ClassLoader loader =</b>
<b class="nc"><i>279</i>&nbsp;                            Thread.currentThread().getContextClassLoader();</b>
<i>280</i>&nbsp;                    if (loader == null) {
<i>281</i>&nbsp;                        // Don&#39;t use bootstrap class loader directly to ensure
<b class="nc"><i>282</i>&nbsp;                        // proper package access control!</b>
<b class="nc"><i>283</i>&nbsp;                        loader = ClassLoader.getSystemClassLoader();</b>
<i>284</i>&nbsp;                    }
<i>285</i>&nbsp;
<b class="nc"><i>286</i>&nbsp;                    return loader;</b>
<i>287</i>&nbsp;                }
<i>288</i>&nbsp;        });
<b class="nc"><i>289</i>&nbsp;    }</b>
<i>290</i>&nbsp;
<i>291</i>&nbsp;    private void loadDefaultCallbackHandler() throws LoginException {
<i>292</i>&nbsp;
<i>293</i>&nbsp;        // get the default handler class
<i>294</i>&nbsp;        try {
<i>295</i>&nbsp;
<i>296</i>&nbsp;            final ClassLoader finalLoader = contextClassLoader;
<i>297</i>&nbsp;
<i>298</i>&nbsp;            this.callbackHandler = java.security.AccessController.doPrivileged(
<b class="nc"><i>299</i>&nbsp;                new java.security.PrivilegedExceptionAction&lt;CallbackHandler&gt;() {</b>
<i>300</i>&nbsp;                public CallbackHandler run() throws Exception {
<b class="nc"><i>301</i>&nbsp;                    String defaultHandler = java.security.Security.getProperty</b>
<b class="nc"><i>302</i>&nbsp;                        (DEFAULT_HANDLER);</b>
<i>303</i>&nbsp;                    if (defaultHandler == null || defaultHandler.length() == 0)
<b class="nc"><i>304</i>&nbsp;                        return null;</b>
<b class="nc"><i>305</i>&nbsp;                    Class&lt;? extends CallbackHandler&gt; c = Class.forName(</b>
<b class="nc"><i>306</i>&nbsp;                            defaultHandler, true,</b>
<b class="nc"><i>307</i>&nbsp;                            finalLoader).asSubclass(CallbackHandler.class);</b>
<b class="nc"><i>308</i>&nbsp;                    @SuppressWarnings(&quot;deprecation&quot;)</b>
<i>309</i>&nbsp;                    CallbackHandler result = c.newInstance();
<b class="nc"><i>310</i>&nbsp;                    return result;</b>
<b class="nc"><i>311</i>&nbsp;                }</b>
<i>312</i>&nbsp;            });
<i>313</i>&nbsp;        } catch (java.security.PrivilegedActionException pae) {
<b class="nc"><i>314</i>&nbsp;            throw new LoginException(pae.getException().toString());</b>
<b class="nc"><i>315</i>&nbsp;        }</b>
<b class="nc"><i>316</i>&nbsp;</b>
<i>317</i>&nbsp;        // secure it with the caller&#39;s ACC
<i>318</i>&nbsp;        if (this.callbackHandler != null &amp;&amp; creatorAcc == null) {
<b class="nc"><i>319</i>&nbsp;            this.callbackHandler = new SecureCallbackHandler</b>
<b class="nc"><i>320</i>&nbsp;                                (java.security.AccessController.getContext(),</b>
<b class="nc"><i>321</i>&nbsp;                                this.callbackHandler);</b>
<i>322</i>&nbsp;        }
<i>323</i>&nbsp;    }
<i>324</i>&nbsp;
<i>325</i>&nbsp;    /**
<i>326</i>&nbsp;     * Instantiate a new {@code LoginContext} object with a name.
<i>327</i>&nbsp;     *
<i>328</i>&nbsp;     * @param name the name used as the index into the
<i>329</i>&nbsp;     *          {@code Configuration}.
<i>330</i>&nbsp;     *
<i>331</i>&nbsp;     * @exception LoginException if the caller-specified {@code name}
<i>332</i>&nbsp;     *          does not appear in the {@code Configuration}
<i>333</i>&nbsp;     *          and there is no {@code Configuration} entry
<i>334</i>&nbsp;     *          for &quot;{@code other}&quot;, or if the
<i>335</i>&nbsp;     *          {@code auth.login.defaultCallbackHandler}
<i>336</i>&nbsp;     *          security property was set, but the implementation
<i>337</i>&nbsp;     *          class could not be loaded.
<i>338</i>&nbsp;     *
<i>339</i>&nbsp;     * @exception SecurityException if a SecurityManager is set and
<i>340</i>&nbsp;     *          the caller does not have
<i>341</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.&lt;i&gt;name&lt;/i&gt;&quot;),
<i>342</i>&nbsp;     *          or if a configuration entry for {@code name} does not exist and
<i>343</i>&nbsp;     *          the caller does not additionally have
<i>344</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.other&quot;)
<i>345</i>&nbsp;     */
<i>346</i>&nbsp;    public LoginContext(String name) throws LoginException {
<b class="nc"><i>347</i>&nbsp;        init(name);</b>
<b class="nc"><i>348</i>&nbsp;        loadDefaultCallbackHandler();</b>
<b class="nc"><i>349</i>&nbsp;    }</b>
<i>350</i>&nbsp;
<i>351</i>&nbsp;    /**
<i>352</i>&nbsp;     * Instantiate a new {@code LoginContext} object with a name
<i>353</i>&nbsp;     * and a {@code Subject} object.
<i>354</i>&nbsp;     *
<i>355</i>&nbsp;     * @param name the name used as the index into the
<i>356</i>&nbsp;     *          {@code Configuration}.
<i>357</i>&nbsp;     *
<i>358</i>&nbsp;     * @param subject the {@code Subject} to authenticate.
<i>359</i>&nbsp;     *
<i>360</i>&nbsp;     * @exception LoginException if the caller-specified {@code name}
<i>361</i>&nbsp;     *          does not appear in the {@code Configuration}
<i>362</i>&nbsp;     *          and there is no {@code Configuration} entry
<i>363</i>&nbsp;     *          for &quot;&lt;i&gt;other&lt;/i&gt;&quot;, if the caller-specified {@code subject}
<i>364</i>&nbsp;     *          is {@code null}, or if the
<i>365</i>&nbsp;     *          &lt;i&gt;auth.login.defaultCallbackHandler&lt;/i&gt;
<i>366</i>&nbsp;     *          security property was set, but the implementation
<i>367</i>&nbsp;     *          class could not be loaded.
<i>368</i>&nbsp;     *
<i>369</i>&nbsp;     * @exception SecurityException if a SecurityManager is set and
<i>370</i>&nbsp;     *          the caller does not have
<i>371</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.&lt;i&gt;name&lt;/i&gt;&quot;),
<i>372</i>&nbsp;     *          or if a configuration entry for &lt;i&gt;name&lt;/i&gt; does not exist and
<i>373</i>&nbsp;     *          the caller does not additionally have
<i>374</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.other&quot;)
<i>375</i>&nbsp;     */
<i>376</i>&nbsp;    public LoginContext(String name, Subject subject)
<i>377</i>&nbsp;    throws LoginException {
<i>378</i>&nbsp;        init(name);
<i>379</i>&nbsp;        if (subject == null)
<b class="nc"><i>380</i>&nbsp;            throw new LoginException</b>
<b class="nc"><i>381</i>&nbsp;                (ResourcesMgr.getString(&quot;invalid.null.Subject.provided&quot;));</b>
<b class="nc"><i>382</i>&nbsp;        this.subject = subject;</b>
<b class="nc"><i>383</i>&nbsp;        subjectProvided = true;</b>
<b class="nc"><i>384</i>&nbsp;        loadDefaultCallbackHandler();</b>
<b class="nc"><i>385</i>&nbsp;    }</b>
<b class="nc"><i>386</i>&nbsp;</b>
<b class="nc"><i>387</i>&nbsp;    /**</b>
<i>388</i>&nbsp;     * Instantiate a new {@code LoginContext} object with a name
<i>389</i>&nbsp;     * and a {@code CallbackHandler} object.
<i>390</i>&nbsp;     *
<i>391</i>&nbsp;     * @param name the name used as the index into the
<i>392</i>&nbsp;     *          {@code Configuration}.
<i>393</i>&nbsp;     *
<i>394</i>&nbsp;     * @param callbackHandler the {@code CallbackHandler} object used by
<i>395</i>&nbsp;     *          LoginModules to communicate with the user.
<i>396</i>&nbsp;     *
<i>397</i>&nbsp;     * @exception LoginException if the caller-specified {@code name}
<i>398</i>&nbsp;     *          does not appear in the {@code Configuration}
<i>399</i>&nbsp;     *          and there is no {@code Configuration} entry
<i>400</i>&nbsp;     *          for &quot;{@code other}&quot;, or if the caller-specified
<i>401</i>&nbsp;     *          {@code callbackHandler} is {@code null}.
<i>402</i>&nbsp;     *
<i>403</i>&nbsp;     * @exception SecurityException if a SecurityManager is set and
<i>404</i>&nbsp;     *          the caller does not have
<i>405</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.&lt;i&gt;name&lt;/i&gt;&quot;),
<i>406</i>&nbsp;     *          or if a configuration entry for &lt;i&gt;name&lt;/i&gt; does not exist and
<i>407</i>&nbsp;     *          the caller does not additionally have
<i>408</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.other&quot;)
<i>409</i>&nbsp;     */
<i>410</i>&nbsp;    public LoginContext(String name, CallbackHandler callbackHandler)
<i>411</i>&nbsp;    throws LoginException {
<i>412</i>&nbsp;        init(name);
<i>413</i>&nbsp;        if (callbackHandler == null)
<i>414</i>&nbsp;            throw new LoginException(ResourcesMgr.getString
<i>415</i>&nbsp;                                (&quot;invalid.null.CallbackHandler.provided&quot;));
<b class="nc"><i>416</i>&nbsp;        this.callbackHandler = new SecureCallbackHandler</b>
<b class="nc"><i>417</i>&nbsp;                                (java.security.AccessController.getContext(),</b>
<b class="nc"><i>418</i>&nbsp;                                callbackHandler);</b>
<b class="nc"><i>419</i>&nbsp;    }</b>
<b class="nc"><i>420</i>&nbsp;</b>
<b class="nc"><i>421</i>&nbsp;    /**</b>
<b class="nc"><i>422</i>&nbsp;     * Instantiate a new {@code LoginContext} object with a name,</b>
<i>423</i>&nbsp;     * a {@code Subject} to be authenticated, and a
<i>424</i>&nbsp;     * {@code CallbackHandler} object.
<i>425</i>&nbsp;     *
<i>426</i>&nbsp;     * @param name the name used as the index into the
<i>427</i>&nbsp;     *          {@code Configuration}.
<i>428</i>&nbsp;     *
<i>429</i>&nbsp;     * @param subject the {@code Subject} to authenticate.
<i>430</i>&nbsp;     *
<i>431</i>&nbsp;     * @param callbackHandler the {@code CallbackHandler} object used by
<i>432</i>&nbsp;     *          LoginModules to communicate with the user.
<i>433</i>&nbsp;     *
<i>434</i>&nbsp;     * @exception LoginException if the caller-specified {@code name}
<i>435</i>&nbsp;     *          does not appear in the {@code Configuration}
<i>436</i>&nbsp;     *          and there is no {@code Configuration} entry
<i>437</i>&nbsp;     *          for &quot;&lt;i&gt;other&lt;/i&gt;&quot;, or if the caller-specified
<i>438</i>&nbsp;     *          {@code subject} is {@code null},
<i>439</i>&nbsp;     *          or if the caller-specified
<i>440</i>&nbsp;     *          {@code callbackHandler} is {@code null}.
<i>441</i>&nbsp;     *
<i>442</i>&nbsp;     * @exception SecurityException if a SecurityManager is set and
<i>443</i>&nbsp;     *          the caller does not have
<i>444</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.&lt;i&gt;name&lt;/i&gt;&quot;),
<i>445</i>&nbsp;     *          or if a configuration entry for &lt;i&gt;name&lt;/i&gt; does not exist and
<i>446</i>&nbsp;     *          the caller does not additionally have
<i>447</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.other&quot;)
<i>448</i>&nbsp;     */
<i>449</i>&nbsp;    public LoginContext(String name, Subject subject,
<i>450</i>&nbsp;                        CallbackHandler callbackHandler) throws LoginException {
<i>451</i>&nbsp;        this(name, subject);
<i>452</i>&nbsp;        if (callbackHandler == null)
<i>453</i>&nbsp;            throw new LoginException(ResourcesMgr.getString
<i>454</i>&nbsp;                                (&quot;invalid.null.CallbackHandler.provided&quot;));
<i>455</i>&nbsp;        this.callbackHandler = new SecureCallbackHandler
<i>456</i>&nbsp;                                (java.security.AccessController.getContext(),
<i>457</i>&nbsp;                                callbackHandler);
<b class="nc"><i>458</i>&nbsp;    }</b>
<b class="nc"><i>459</i>&nbsp;</b>
<b class="nc"><i>460</i>&nbsp;    /**</b>
<b class="nc"><i>461</i>&nbsp;     * Instantiate a new {@code LoginContext} object with a name,</b>
<b class="nc"><i>462</i>&nbsp;     * a {@code Subject} to be authenticated,</b>
<b class="nc"><i>463</i>&nbsp;     * a {@code CallbackHandler} object, and a login {@code Configuration}.</b>
<i>464</i>&nbsp;     *
<i>465</i>&nbsp;     * @param name the name used as the index into the caller-specified
<i>466</i>&nbsp;     *          {@code Configuration}.
<i>467</i>&nbsp;     *
<i>468</i>&nbsp;     * @param subject the {@code Subject} to authenticate,
<i>469</i>&nbsp;     *          or {@code null}.
<i>470</i>&nbsp;     *
<i>471</i>&nbsp;     * @param callbackHandler the {@code CallbackHandler} object used by
<i>472</i>&nbsp;     *          LoginModules to communicate with the user, or {@code null}.
<i>473</i>&nbsp;     *
<i>474</i>&nbsp;     * @param config the {@code Configuration} that lists the
<i>475</i>&nbsp;     *          login modules to be called to perform the authentication,
<i>476</i>&nbsp;     *          or {@code null}.
<i>477</i>&nbsp;     *
<i>478</i>&nbsp;     * @exception LoginException if the caller-specified {@code name}
<i>479</i>&nbsp;     *          does not appear in the {@code Configuration}
<i>480</i>&nbsp;     *          and there is no {@code Configuration} entry
<i>481</i>&nbsp;     *          for &quot;&lt;i&gt;other&lt;/i&gt;&quot;.
<i>482</i>&nbsp;     *
<i>483</i>&nbsp;     * @exception SecurityException if a SecurityManager is set,
<i>484</i>&nbsp;     *          &lt;i&gt;config&lt;/i&gt; is {@code null},
<i>485</i>&nbsp;     *          and either the caller does not have
<i>486</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.&lt;i&gt;name&lt;/i&gt;&quot;),
<i>487</i>&nbsp;     *          or if a configuration entry for &lt;i&gt;name&lt;/i&gt; does not exist and
<i>488</i>&nbsp;     *          the caller does not additionally have
<i>489</i>&nbsp;     *          AuthPermission(&quot;createLoginContext.other&quot;)
<i>490</i>&nbsp;     *
<i>491</i>&nbsp;     * @since 1.5
<i>492</i>&nbsp;     */
<i>493</i>&nbsp;    public LoginContext(String name, Subject subject,
<i>494</i>&nbsp;                        CallbackHandler callbackHandler,
<i>495</i>&nbsp;                        Configuration config) throws LoginException {
<i>496</i>&nbsp;        this.config = config;
<i>497</i>&nbsp;        if (config != null) {
<i>498</i>&nbsp;            creatorAcc = java.security.AccessController.getContext();
<i>499</i>&nbsp;        }
<i>500</i>&nbsp;
<i>501</i>&nbsp;        init(name);
<i>502</i>&nbsp;        if (subject != null) {
<i>503</i>&nbsp;            this.subject = subject;
<i>504</i>&nbsp;            subjectProvided = true;
<i>505</i>&nbsp;        }
<b class="nc"><i>506</i>&nbsp;        if (callbackHandler == null) {</b>
<b class="nc"><i>507</i>&nbsp;            loadDefaultCallbackHandler();</b>
<b class="nc"><i>508</i>&nbsp;        } else if (creatorAcc == null) {</b>
<b class="nc"><i>509</i>&nbsp;            this.callbackHandler = new SecureCallbackHandler</b>
<i>510</i>&nbsp;                                (java.security.AccessController.getContext(),
<i>511</i>&nbsp;                                callbackHandler);
<b class="nc"><i>512</i>&nbsp;        } else {</b>
<b class="nc"><i>513</i>&nbsp;            this.callbackHandler = callbackHandler;</b>
<b class="nc"><i>514</i>&nbsp;        }</b>
<b class="nc"><i>515</i>&nbsp;    }</b>
<i>516</i>&nbsp;
<b class="nc"><i>517</i>&nbsp;    /**</b>
<b class="nc"><i>518</i>&nbsp;     * Perform the authentication.</b>
<b class="nc"><i>519</i>&nbsp;     *</b>
<b class="nc"><i>520</i>&nbsp;     * &lt;p&gt; This method invokes the {@code login} method for each</b>
<b class="nc"><i>521</i>&nbsp;     * LoginModule configured for the &lt;i&gt;name&lt;/i&gt; specified to the</b>
<i>522</i>&nbsp;     * {@code LoginContext} constructor, as determined by the login
<i>523</i>&nbsp;     * {@code Configuration}.  Each {@code LoginModule}
<b class="nc"><i>524</i>&nbsp;     * then performs its respective type of authentication</b>
<i>525</i>&nbsp;     * (username/password, smart card pin verification, etc.).
<i>526</i>&nbsp;     *
<i>527</i>&nbsp;     * &lt;p&gt; This method completes a 2-phase authentication process by
<i>528</i>&nbsp;     * calling each configured LoginModule&#39;s {@code commit} method
<i>529</i>&nbsp;     * if the overall authentication succeeded (the relevant REQUIRED,
<i>530</i>&nbsp;     * REQUISITE, SUFFICIENT, and OPTIONAL LoginModules succeeded),
<i>531</i>&nbsp;     * or by calling each configured LoginModule&#39;s {@code abort} method
<i>532</i>&nbsp;     * if the overall authentication failed.  If authentication succeeded,
<i>533</i>&nbsp;     * each successful LoginModule&#39;s {@code commit} method associates
<i>534</i>&nbsp;     * the relevant Principals and Credentials with the {@code Subject}.
<i>535</i>&nbsp;     * If authentication failed, each LoginModule&#39;s {@code abort} method
<i>536</i>&nbsp;     * removes/destroys any previously stored state.
<i>537</i>&nbsp;     *
<i>538</i>&nbsp;     * &lt;p&gt; If the {@code commit} phase of the authentication process
<i>539</i>&nbsp;     * fails, then the overall authentication fails and this method
<i>540</i>&nbsp;     * invokes the {@code abort} method for each configured
<i>541</i>&nbsp;     * {@code LoginModule}.
<i>542</i>&nbsp;     *
<i>543</i>&nbsp;     * &lt;p&gt; If the {@code abort} phase
<i>544</i>&nbsp;     * fails for any reason, then this method propagates the
<i>545</i>&nbsp;     * original exception thrown either during the {@code login} phase
<i>546</i>&nbsp;     * or the {@code commit} phase.  In either case, the overall
<i>547</i>&nbsp;     * authentication fails.
<i>548</i>&nbsp;     *
<i>549</i>&nbsp;     * &lt;p&gt; In the case where multiple LoginModules fail,
<i>550</i>&nbsp;     * this method propagates the exception raised by the first
<i>551</i>&nbsp;     * {@code LoginModule} which failed.
<i>552</i>&nbsp;     *
<i>553</i>&nbsp;     * &lt;p&gt; Note that if this method enters the {@code abort} phase
<i>554</i>&nbsp;     * (either the {@code login} or {@code commit} phase failed),
<i>555</i>&nbsp;     * this method invokes all LoginModules configured for the
<i>556</i>&nbsp;     * application regardless of their respective {@code Configuration}
<i>557</i>&nbsp;     * flag parameters.  Essentially this means that {@code Requisite}
<i>558</i>&nbsp;     * and {@code Sufficient} semantics are ignored during the
<i>559</i>&nbsp;     * {@code abort} phase.  This guarantees that proper cleanup
<i>560</i>&nbsp;     * and state restoration can take place.
<i>561</i>&nbsp;     *
<i>562</i>&nbsp;     * @exception LoginException if the authentication fails.
<i>563</i>&nbsp;     */
<i>564</i>&nbsp;    public void login() throws LoginException {
<i>565</i>&nbsp;
<i>566</i>&nbsp;        loginSucceeded = false;
<i>567</i>&nbsp;
<i>568</i>&nbsp;        if (subject == null) {
<i>569</i>&nbsp;            subject = new Subject();
<i>570</i>&nbsp;        }
<i>571</i>&nbsp;
<i>572</i>&nbsp;        try {
<i>573</i>&nbsp;            // module invoked in doPrivileged
<i>574</i>&nbsp;            invokePriv(LOGIN_METHOD);
<i>575</i>&nbsp;            invokePriv(COMMIT_METHOD);
<i>576</i>&nbsp;            loginSucceeded = true;
<i>577</i>&nbsp;        } catch (LoginException le) {
<i>578</i>&nbsp;            try {
<b class="nc"><i>579</i>&nbsp;                invokePriv(ABORT_METHOD);</b>
<i>580</i>&nbsp;            } catch (LoginException le2) {
<b class="nc"><i>581</i>&nbsp;                throw le;</b>
<b class="nc"><i>582</i>&nbsp;            }</b>
<i>583</i>&nbsp;            throw le;
<i>584</i>&nbsp;        }
<i>585</i>&nbsp;    }
<i>586</i>&nbsp;
<b class="nc"><i>587</i>&nbsp;    /**</b>
<b class="nc"><i>588</i>&nbsp;     * Logout the {@code Subject}.</b>
<b class="nc"><i>589</i>&nbsp;     *</b>
<b class="nc"><i>590</i>&nbsp;     * &lt;p&gt; This method invokes the {@code logout} method for each</b>
<i>591</i>&nbsp;     * {@code LoginModule} configured for this {@code LoginContext}.
<b class="nc"><i>592</i>&nbsp;     * Each {@code LoginModule} performs its respective logout procedure</b>
<b class="nc"><i>593</i>&nbsp;     * which may include removing/destroying</b>
<b class="nc"><i>594</i>&nbsp;     * {@code Principal} and {@code Credential} information</b>
<b class="nc"><i>595</i>&nbsp;     * from the {@code Subject} and state cleanup.</b>
<b class="nc"><i>596</i>&nbsp;     *</b>
<b class="nc"><i>597</i>&nbsp;     * &lt;p&gt; Note that this method invokes all LoginModules configured for the</b>
<i>598</i>&nbsp;     * application regardless of their respective
<i>599</i>&nbsp;     * {@code Configuration} flag parameters.  Essentially this means
<i>600</i>&nbsp;     * that {@code Requisite} and {@code Sufficient} semantics are
<i>601</i>&nbsp;     * ignored for this method.  This guarantees that proper cleanup
<i>602</i>&nbsp;     * and state restoration can take place.
<i>603</i>&nbsp;     *
<i>604</i>&nbsp;     * @exception LoginException if the logout fails.
<i>605</i>&nbsp;     */
<i>606</i>&nbsp;    public void logout() throws LoginException {
<i>607</i>&nbsp;        if (subject == null) {
<i>608</i>&nbsp;            throw new LoginException(ResourcesMgr.getString
<i>609</i>&nbsp;                (&quot;null.subject.logout.called.before.login&quot;));
<i>610</i>&nbsp;        }
<i>611</i>&nbsp;
<i>612</i>&nbsp;        // module invoked in doPrivileged
<i>613</i>&nbsp;        invokePriv(LOGOUT_METHOD);
<i>614</i>&nbsp;    }
<i>615</i>&nbsp;
<i>616</i>&nbsp;    /**
<i>617</i>&nbsp;     * Return the authenticated Subject.
<i>618</i>&nbsp;     *
<i>619</i>&nbsp;     * @return the authenticated Subject.  If the caller specified a
<i>620</i>&nbsp;     *          Subject to this LoginContext&#39;s constructor,
<i>621</i>&nbsp;     *          this method returns the caller-specified Subject.
<b class="nc"><i>622</i>&nbsp;     *          If a Subject was not specified and authentication succeeds,</b>
<b class="nc"><i>623</i>&nbsp;     *          this method returns the Subject instantiated and used for</b>
<b class="nc"><i>624</i>&nbsp;     *          authentication by this LoginContext.</b>
<i>625</i>&nbsp;     *          If a Subject was not specified, and authentication fails or
<i>626</i>&nbsp;     *          has not been attempted, this method returns null.
<i>627</i>&nbsp;     */
<b class="nc"><i>628</i>&nbsp;    public Subject getSubject() {</b>
<i>629</i>&nbsp;        if (!loginSucceeded &amp;&amp; !subjectProvided)
<i>630</i>&nbsp;            return null;
<i>631</i>&nbsp;        return subject;
<i>632</i>&nbsp;    }
<i>633</i>&nbsp;
<i>634</i>&nbsp;    private void clearState() {
<i>635</i>&nbsp;        moduleIndex = 0;
<i>636</i>&nbsp;        firstError = null;
<i>637</i>&nbsp;        firstRequiredError = null;
<i>638</i>&nbsp;        success = false;
<i>639</i>&nbsp;    }
<i>640</i>&nbsp;
<i>641</i>&nbsp;    private void throwException(LoginException originalError, LoginException le)
<i>642</i>&nbsp;    throws LoginException {
<i>643</i>&nbsp;
<i>644</i>&nbsp;        // first clear state
<i>645</i>&nbsp;        clearState();
<b class="nc"><i>646</i>&nbsp;</b>
<b class="nc"><i>647</i>&nbsp;        // throw the exception</b>
<b class="nc"><i>648</i>&nbsp;        LoginException error = (originalError != null) ? originalError : le;</b>
<i>649</i>&nbsp;        throw error;
<i>650</i>&nbsp;    }
<i>651</i>&nbsp;
<b class="nc"><i>652</i>&nbsp;    /**</b>
<b class="nc"><i>653</i>&nbsp;     * Invokes the login, commit, and logout methods</b>
<b class="nc"><i>654</i>&nbsp;     * from a LoginModule inside a doPrivileged block restricted</b>
<b class="nc"><i>655</i>&nbsp;     * by creatorAcc (may be null).</b>
<i>656</i>&nbsp;     *
<i>657</i>&nbsp;     * This version is called if the caller did not instantiate
<i>658</i>&nbsp;     * the LoginContext with a Configuration object.
<i>659</i>&nbsp;     */
<i>660</i>&nbsp;    private void invokePriv(final String methodName) throws LoginException {
<i>661</i>&nbsp;        try {
<b class="nc"><i>662</i>&nbsp;            java.security.AccessController.doPrivileged</b>
<i>663</i>&nbsp;                (new java.security.PrivilegedExceptionAction&lt;Void&gt;() {
<i>664</i>&nbsp;                public Void run() throws LoginException {
<b class="nc"><i>665</i>&nbsp;                    invoke(methodName);</b>
<b class="nc"><i>666</i>&nbsp;                    return null;</b>
<i>667</i>&nbsp;                }
<i>668</i>&nbsp;            }, creatorAcc);
<i>669</i>&nbsp;        } catch (java.security.PrivilegedActionException pae) {
<i>670</i>&nbsp;            throw (LoginException)pae.getException();
<i>671</i>&nbsp;        }
<i>672</i>&nbsp;    }
<i>673</i>&nbsp;
<i>674</i>&nbsp;    private void invoke(String methodName) throws LoginException {
<i>675</i>&nbsp;
<i>676</i>&nbsp;        // start at moduleIndex
<i>677</i>&nbsp;        // - this can only be non-zero if methodName is LOGIN_METHOD
<i>678</i>&nbsp;
<b class="nc"><i>679</i>&nbsp;        for (int i = moduleIndex; i &lt; moduleStack.length; i++, moduleIndex++) {</b>
<b class="nc"><i>680</i>&nbsp;            try {</b>
<i>681</i>&nbsp;
<b class="nc"><i>682</i>&nbsp;                if (moduleStack[i].module == null) {</b>
<b class="nc"><i>683</i>&nbsp;</b>
<i>684</i>&nbsp;                    // locate and instantiate the LoginModule
<i>685</i>&nbsp;                    //
<b class="nc"><i>686</i>&nbsp;                    String name = moduleStack[i].entry.getLoginModuleName();</b>
<b class="nc"><i>687</i>&nbsp;                    ServiceLoader&lt;LoginModule&gt; sc = AccessController.doPrivileged(</b>
<b class="nc"><i>688</i>&nbsp;                            (PrivilegedAction&lt;ServiceLoader&lt;LoginModule&gt;&gt;)</b>
<i>689</i>&nbsp;                                    () -&gt; ServiceLoader.load(
<i>690</i>&nbsp;                                        LoginModule.class, contextClassLoader));
<i>691</i>&nbsp;                    for (LoginModule m: sc) {
<i>692</i>&nbsp;                        if (m.getClass().getName().equals(name)) {
<i>693</i>&nbsp;                            moduleStack[i].module = m;
<i>694</i>&nbsp;                            if (debug != null) {
<i>695</i>&nbsp;                                debug.println(name + &quot; loaded as a service&quot;);
<b class="nc"><i>696</i>&nbsp;                            }</b>
<i>697</i>&nbsp;                            break;
<i>698</i>&nbsp;                        }
<b class="nc"><i>699</i>&nbsp;                    }</b>
<b class="nc"><i>700</i>&nbsp;</b>
<i>701</i>&nbsp;                    if (moduleStack[i].module == null) {
<b class="nc"><i>702</i>&nbsp;                        try {</b>
<b class="nc"><i>703</i>&nbsp;                            @SuppressWarnings(&quot;deprecation&quot;)</b>
<i>704</i>&nbsp;                            Object tmp = Class.forName(name, false, contextClassLoader).newInstance();
<i>705</i>&nbsp;                            moduleStack[i].module = (LoginModule) tmp;
<i>706</i>&nbsp;                            if (debug != null) {
<i>707</i>&nbsp;                                debug.println(name + &quot; loaded via reflection&quot;);
<i>708</i>&nbsp;                            }
<i>709</i>&nbsp;                        } catch (ClassNotFoundException e) {
<b class="nc"><i>710</i>&nbsp;                            throw new LoginException(&quot;No LoginModule found for &quot;</b>
<b class="nc"><i>711</i>&nbsp;                                    + name);</b>
<i>712</i>&nbsp;                        }
<i>713</i>&nbsp;                    }
<i>714</i>&nbsp;
<b class="nc"><i>715</i>&nbsp;                    // invoke the LoginModule initialize method</b>
<b class="nc"><i>716</i>&nbsp;                    moduleStack[i].module.initialize(subject,</b>
<b class="nc"><i>717</i>&nbsp;                            callbackHandler,</b>
<i>718</i>&nbsp;                            state,
<i>719</i>&nbsp;                            moduleStack[i].entry.getOptions());
<b class="nc"><i>720</i>&nbsp;                }</b>
<b class="nc"><i>721</i>&nbsp;</b>
<b class="nc"><i>722</i>&nbsp;                // find the requested method in the LoginModule</b>
<b class="nc"><i>723</i>&nbsp;                boolean status;</b>
<i>724</i>&nbsp;                switch (methodName) {
<i>725</i>&nbsp;                    case LOGIN_METHOD:
<i>726</i>&nbsp;                        status = moduleStack[i].module.login();
<b class="nc"><i>727</i>&nbsp;                        break;</b>
<i>728</i>&nbsp;                    case COMMIT_METHOD:
<i>729</i>&nbsp;                        status = moduleStack[i].module.commit();
<b class="nc"><i>730</i>&nbsp;                        break;</b>
<i>731</i>&nbsp;                    case LOGOUT_METHOD:
<i>732</i>&nbsp;                        status = moduleStack[i].module.logout();
<i>733</i>&nbsp;                        break;
<i>734</i>&nbsp;                    case ABORT_METHOD:
<i>735</i>&nbsp;                        status = moduleStack[i].module.abort();
<b class="nc"><i>736</i>&nbsp;                        break;</b>
<i>737</i>&nbsp;                    default:
<i>738</i>&nbsp;                        throw new AssertionError(&quot;Unknown method &quot; + methodName);
<i>739</i>&nbsp;                }
<b class="nc"><i>740</i>&nbsp;</b>
<b class="nc"><i>741</i>&nbsp;                if (status == true) {</b>
<b class="nc"><i>742</i>&nbsp;</b>
<i>743</i>&nbsp;                    // if SUFFICIENT, return if no prior REQUIRED errors
<i>744</i>&nbsp;                    if (!methodName.equals(ABORT_METHOD) &amp;&amp;
<i>745</i>&nbsp;                        !methodName.equals(LOGOUT_METHOD) &amp;&amp;
<i>746</i>&nbsp;                        moduleStack[i].entry.getControlFlag() ==
<b class="nc"><i>747</i>&nbsp;                    AppConfigurationEntry.LoginModuleControlFlag.SUFFICIENT &amp;&amp;</b>
<i>748</i>&nbsp;                        firstRequiredError == null) {
<i>749</i>&nbsp;
<i>750</i>&nbsp;                        // clear state
<i>751</i>&nbsp;                        clearState();
<i>752</i>&nbsp;
<i>753</i>&nbsp;                        if (debug != null)
<b class="nc"><i>754</i>&nbsp;                            debug.println(methodName + &quot; SUFFICIENT success&quot;);</b>
<b class="nc"><i>755</i>&nbsp;                        return;</b>
<i>756</i>&nbsp;                    }
<b class="nc"><i>757</i>&nbsp;</b>
<i>758</i>&nbsp;                    if (debug != null)
<i>759</i>&nbsp;                        debug.println(methodName + &quot; success&quot;);
<b class="nc"><i>760</i>&nbsp;                    success = true;</b>
<b class="nc"><i>761</i>&nbsp;                } else {</b>
<b class="nc"><i>762</i>&nbsp;                    if (debug != null)</b>
<i>763</i>&nbsp;                        debug.println(methodName + &quot; ignored&quot;);
<i>764</i>&nbsp;                }
<i>765</i>&nbsp;            } catch (Exception ite) {
<i>766</i>&nbsp;
<b class="nc"><i>767</i>&nbsp;                // failure cases</b>
<i>768</i>&nbsp;                LoginException le;
<b class="nc"><i>769</i>&nbsp;</b>
<b class="nc"><i>770</i>&nbsp;                if (ite instanceof PendingException &amp;&amp;</b>
<i>771</i>&nbsp;                    methodName.equals(LOGIN_METHOD)) {
<i>772</i>&nbsp;
<i>773</i>&nbsp;                    // XXX
<b class="nc"><i>774</i>&nbsp;                    //</b>
<b class="nc"><i>775</i>&nbsp;                    // if a module&#39;s LOGIN_METHOD threw a PendingException</b>
<b class="nc"><i>776</i>&nbsp;                    // then immediately throw it.</b>
<i>777</i>&nbsp;                    //
<b class="nc"><i>778</i>&nbsp;                    // when LoginContext is called again,</b>
<b class="nc"><i>779</i>&nbsp;                    // the module that threw the exception is invoked first</b>
<i>780</i>&nbsp;                    // (the module list is not invoked from the start).
<i>781</i>&nbsp;                    // previously thrown exception state is still present.
<b class="nc"><i>782</i>&nbsp;                    //</b>
<b class="nc"><i>783</i>&nbsp;                    // it is assumed that the module which threw</b>
<b class="nc"><i>784</i>&nbsp;                    // the exception can have its</b>
<b class="nc"><i>785</i>&nbsp;                    // LOGIN_METHOD invoked twice in a row</b>
<b class="nc"><i>786</i>&nbsp;                    // without any commit/abort in between.</b>
<b class="nc"><i>787</i>&nbsp;                    //</b>
<b class="nc"><i>788</i>&nbsp;                    // in all cases when LoginContext returns</b>
<b class="nc"><i>789</i>&nbsp;                    // (either via natural return or by throwing an exception)</b>
<b class="nc"><i>790</i>&nbsp;                    // we need to call clearState before returning.</b>
<b class="nc"><i>791</i>&nbsp;                    // the only time that is not true is in this case -</b>
<b class="nc"><i>792</i>&nbsp;                    // do not call throwException here.</b>
<b class="nc"><i>793</i>&nbsp;</b>
<b class="nc"><i>794</i>&nbsp;                    throw (PendingException)ite;</b>
<b class="nc"><i>795</i>&nbsp;</b>
<b class="nc"><i>796</i>&nbsp;                } else if (ite instanceof LoginException) {</b>
<b class="nc"><i>797</i>&nbsp;</b>
<b class="nc"><i>798</i>&nbsp;                    le = (LoginException)ite;</b>
<b class="nc"><i>799</i>&nbsp;</b>
<i>800</i>&nbsp;                } else if (ite instanceof SecurityException) {
<i>801</i>&nbsp;
<i>802</i>&nbsp;                    // do not want privacy leak
<i>803</i>&nbsp;                    // (e.g., sensitive file path in exception msg)
<i>804</i>&nbsp;
<b class="nc"><i>805</i>&nbsp;                    le = new LoginException(&quot;Security Exception&quot;);</b>
<b class="nc"><i>806</i>&nbsp;                    le.initCause(new SecurityException());</b>
<i>807</i>&nbsp;                    if (debug != null) {
<i>808</i>&nbsp;                        debug.println
<i>809</i>&nbsp;                            (&quot;original security exception with detail msg &quot; +
<i>810</i>&nbsp;                            &quot;replaced by new exception with empty detail msg&quot;);
<i>811</i>&nbsp;                        debug.println(&quot;original security exception: &quot; +
<i>812</i>&nbsp;                                ite.toString());
<i>813</i>&nbsp;                    }
<i>814</i>&nbsp;                } else {
<i>815</i>&nbsp;
<i>816</i>&nbsp;                    // capture an unexpected LoginModule exception
<i>817</i>&nbsp;                    java.io.StringWriter sw = new java.io.StringWriter();
<i>818</i>&nbsp;                    ite.printStackTrace
<i>819</i>&nbsp;                            (new java.io.PrintWriter(sw));
<i>820</i>&nbsp;                    sw.flush();
<i>821</i>&nbsp;                    le = new LoginException(sw.toString());
<i>822</i>&nbsp;                }
<i>823</i>&nbsp;
<i>824</i>&nbsp;                if (moduleStack[i].entry.getControlFlag() ==
<i>825</i>&nbsp;                    AppConfigurationEntry.LoginModuleControlFlag.REQUISITE) {
<i>826</i>&nbsp;
<i>827</i>&nbsp;                    if (debug != null)
<i>828</i>&nbsp;                        debug.println(methodName + &quot; REQUISITE failure&quot;);
<b class="nc"><i>829</i>&nbsp;</b>
<i>830</i>&nbsp;                    // if REQUISITE, then immediately throw an exception
<b class="nc"><i>831</i>&nbsp;                    if (methodName.equals(ABORT_METHOD) ||</b>
<i>832</i>&nbsp;                        methodName.equals(LOGOUT_METHOD)) {
<b class="nc"><i>833</i>&nbsp;                        if (firstRequiredError == null)</b>
<i>834</i>&nbsp;                            firstRequiredError = le;
<b class="nc"><i>835</i>&nbsp;                    } else {</b>
<i>836</i>&nbsp;                        throwException(firstRequiredError, le);
<i>837</i>&nbsp;                    }
<i>838</i>&nbsp;
<i>839</i>&nbsp;                } else if (moduleStack[i].entry.getControlFlag() ==
<b class="nc"><i>840</i>&nbsp;                    AppConfigurationEntry.LoginModuleControlFlag.REQUIRED) {</b>
<b class="nc"><i>841</i>&nbsp;</b>
<b class="nc"><i>842</i>&nbsp;                    if (debug != null)</b>
<b class="nc"><i>843</i>&nbsp;                        debug.println(methodName + &quot; REQUIRED failure&quot;);</b>
<b class="nc"><i>844</i>&nbsp;</b>
<i>845</i>&nbsp;                    // mark down that a REQUIRED module failed
<b class="nc"><i>846</i>&nbsp;                    if (firstRequiredError == null)</b>
<b class="nc"><i>847</i>&nbsp;                        firstRequiredError = le;</b>
<i>848</i>&nbsp;
<i>849</i>&nbsp;                } else {
<i>850</i>&nbsp;
<i>851</i>&nbsp;                    if (debug != null)
<b class="nc"><i>852</i>&nbsp;                        debug.println(methodName + &quot; OPTIONAL failure&quot;);</b>
<b class="nc"><i>853</i>&nbsp;</b>
<b class="nc"><i>854</i>&nbsp;                    // mark down that an OPTIONAL module failed</b>
<b class="nc"><i>855</i>&nbsp;                    if (firstError == null)</b>
<b class="nc"><i>856</i>&nbsp;                        firstError = le;</b>
<i>857</i>&nbsp;                }
<i>858</i>&nbsp;            }
<b class="nc"><i>859</i>&nbsp;        }</b>
<i>860</i>&nbsp;
<i>861</i>&nbsp;        // we went thru all the LoginModules.
<b class="nc"><i>862</i>&nbsp;        if (firstRequiredError != null) {</b>
<b class="nc"><i>863</i>&nbsp;            // a REQUIRED module failed -- return the error</b>
<i>864</i>&nbsp;            throwException(firstRequiredError, null);
<i>865</i>&nbsp;        } else if (success == false &amp;&amp; firstError != null) {
<b class="nc"><i>866</i>&nbsp;            // no module succeeded -- return the first error</b>
<b class="nc"><i>867</i>&nbsp;            throwException(firstError, null);</b>
<b class="nc"><i>868</i>&nbsp;        } else if (success == false) {</b>
<b class="nc"><i>869</i>&nbsp;            // no module succeeded -- all modules were IGNORED</b>
<i>870</i>&nbsp;            throwException(new LoginException
<b class="nc"><i>871</i>&nbsp;                (ResourcesMgr.getString(&quot;Login.Failure.all.modules.ignored&quot;)),</b>
<i>872</i>&nbsp;                null);
<i>873</i>&nbsp;        } else {
<b class="nc"><i>874</i>&nbsp;            // success</b>
<i>875</i>&nbsp;
<i>876</i>&nbsp;            clearState();
<b class="nc"><i>877</i>&nbsp;            return;</b>
<b class="nc"><i>878</i>&nbsp;        }</b>
<i>879</i>&nbsp;    }
<i>880</i>&nbsp;
<b class="nc"><i>881</i>&nbsp;    /**</b>
<b class="nc"><i>882</i>&nbsp;     * Wrap the caller-specified CallbackHandler in our own</b>
<i>883</i>&nbsp;     * and invoke it within a privileged block, constrained by
<i>884</i>&nbsp;     * the caller&#39;s AccessControlContext.
<i>885</i>&nbsp;     */
<b class="nc"><i>886</i>&nbsp;    private static class SecureCallbackHandler implements CallbackHandler {</b>
<b class="nc"><i>887</i>&nbsp;</b>
<i>888</i>&nbsp;        private final java.security.AccessControlContext acc;
<i>889</i>&nbsp;        private final CallbackHandler ch;
<b class="nc"><i>890</i>&nbsp;</b>
<b class="nc"><i>891</i>&nbsp;        SecureCallbackHandler(java.security.AccessControlContext acc,</b>
<i>892</i>&nbsp;                        CallbackHandler ch) {
<b class="nc"><i>893</i>&nbsp;            this.acc = acc;</b>
<i>894</i>&nbsp;            this.ch = ch;
<i>895</i>&nbsp;        }
<i>896</i>&nbsp;
<b class="nc"><i>897</i>&nbsp;        public void handle(final Callback[] callbacks)</b>
<i>898</i>&nbsp;                throws java.io.IOException, UnsupportedCallbackException {
<b class="nc"><i>899</i>&nbsp;            try {</b>
<b class="nc"><i>900</i>&nbsp;                java.security.AccessController.doPrivileged</b>
<i>901</i>&nbsp;                    (new java.security.PrivilegedExceptionAction&lt;Void&gt;() {
<b class="nc"><i>902</i>&nbsp;                    public Void run() throws java.io.IOException,</b>
<b class="nc"><i>903</i>&nbsp;                                        UnsupportedCallbackException {</b>
<i>904</i>&nbsp;                        ch.handle(callbacks);
<b class="nc"><i>905</i>&nbsp;                        return null;</b>
<b class="nc"><i>906</i>&nbsp;                    }</b>
<i>907</i>&nbsp;                }, acc);
<i>908</i>&nbsp;            } catch (java.security.PrivilegedActionException pae) {
<i>909</i>&nbsp;                if (pae.getException() instanceof java.io.IOException) {
<i>910</i>&nbsp;                    throw (java.io.IOException)pae.getException();
<b class="nc"><i>911</i>&nbsp;                } else {</b>
<i>912</i>&nbsp;                    throw (UnsupportedCallbackException)pae.getException();
<i>913</i>&nbsp;                }
<i>914</i>&nbsp;            }
<i>915</i>&nbsp;        }
<i>916</i>&nbsp;    }
<i>917</i>&nbsp;
<i>918</i>&nbsp;    /**
<i>919</i>&nbsp;     * LoginModule information -
<i>920</i>&nbsp;     *          incapsulates Configuration info and actual module instances
<b class="nc"><i>921</i>&nbsp;     */</b>
<i>922</i>&nbsp;    private static class ModuleInfo {
<i>923</i>&nbsp;        AppConfigurationEntry entry;
<i>924</i>&nbsp;        LoginModule module;
<i>925</i>&nbsp;
<i>926</i>&nbsp;        ModuleInfo(AppConfigurationEntry newEntry, LoginModule newModule) {
<b class="nc"><i>927</i>&nbsp;            this.entry = newEntry;</b>
<b class="nc"><i>928</i>&nbsp;            this.module = newModule;</b>
<b class="nc"><i>929</i>&nbsp;        }</b>
<i>930</i>&nbsp;    }
<i>931</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2018-11-19 23:10</div>
</div>
</body>
</html>
